<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西游记动态人物关系图谱</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #050505;
            color: #fff;
            font-family: 'Ma Shan Zheng', cursive;
            overflow: hidden;
        }

        #header {
            text-align: center;
            margin-bottom: 20px;
            z-index: 10;
            position: relative;
        }

        h1 {
            color: #ddd;
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            letter-spacing: 4px;
        }

        p {
            color: #bdc3c7;
            font-size: 1rem;
            margin: 0;
        }

        #chart-container {
            width: 100%;
            height: calc(100vh - 120px);
            position: relative;
        }

        svg {
            display: block;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000 90%);
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        }

        /* 连线样式 */
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1px;
        }

        /* 节点样式 */
        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            cursor: pointer;
            transition: stroke 0.3s ease;
        }

        .nodes circle:hover {
            stroke: #f1c40f;
            stroke-width: 3px;
        }

        /* 节点文字样式 */
        .node-label {
            font-family: 'Ma Shan Zheng', cursive;
            fill: #fff;
            pointer-events: none;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            text-anchor: middle;
        }

        /* 连线关系文字样式 */
        .link-label {
            font-family: 'Ma Shan Zheng', cursive;
            fill: #aaa; /* 稍微暗一点的颜色，避免太抢眼 */
            pointer-events: none;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.9); /* 加重阴影以在连线上看清 */
            text-anchor: middle;
            dominant-baseline: central;
        }

        /* 背景雾效和星星 */
        .fog {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url('https://raw.githubusercontent.com/yoshiharuyamashita/css-fog-animation/master/img/fog1.png') repeat-x;
            background-size: contain;
            opacity: 0.1;
            animation: moveFog 60s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes moveFog {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-50%, 0, 0); }
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
    </style>
</head>

<body>
    <div class="stars">
        <div class="star" style="top: 15%; left: 20%; animation-delay: 0s;"></div>
        <div class="star" style="top: 25%; left: 80%; animation-delay: 0.5s;"></div>
        <div class="star" style="top: 40%; left: 10%; animation-delay: 1s;"></div>
        <div class="star" style="top: 60%; left: 70%; animation-delay: 1.5s;"></div>
        <div class="star" style="top: 80%; left: 30%; animation-delay: 2s;"></div>
    </div>
    <div class="fog"></div>

    <div id="header">
        <h1>西游记动态人物关系图谱</h1>
        <p>点击人物查看详情，拖拽节点探索关系，鼠标滚轮缩放。</p>
    </div>

    <div id="chart-container">
        <svg viewBox="0 0 960 600"></svg>
    </div>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
        // ==========================================
        // 0. 配置区域
        // ==========================================
        const CONFIG = {
            initialZoom: 0.7,      // 初始缩放
            nodeRadiusDivisor: 70, // 节点大小系数 (越小节点越大)
            nodeFontSize: 14,      // 节点文字大小 (人物名)
            linkFontSize: 10,      // 连线文字大小 (关系名) - 调小以符合要求
            linkDistance: 120,     // 连线长度
        };

        // ==========================================
        // 1. 数据接收与处理
        // ==========================================

        // 接收后端传递的 JSON 数据
        var serverData = {{ relationships|safe }};

        // 将后端字典列表转换为 D3 需要的 Nodes 和 Links
        function processData(data) {
            var nodesMap = {};
            var links = [];

            data.forEach(function(rel) {
                // 1. 提取来源节点
                if (!nodesMap[rel.from_character.id]) {
                    nodesMap[rel.from_character.id] = {
                        id: rel.from_character.id,
                        name: rel.from_character.name,
                        group: rel.from_character.id % 20 // 简单的分组颜色
                    };
                }
                // 2. 提取目标节点
                if (!nodesMap[rel.to_character.id]) {
                    nodesMap[rel.to_character.id] = {
                        id: rel.to_character.id,
                        name: rel.to_character.name,
                        group: rel.to_character.id % 20
                    };
                }

                // 3. 提取连线关系
                // 核心修改：确保 relationship_type.name 被正确读取
                // 如果后端传来空字符串，可以使用 || "关系" 提供默认值
                var relName = rel.relationship_type.name || "";

                links.push({
                    source: rel.from_character.id, // D3 v4 会自动匹配 id
                    target: rel.to_character.id,
                    type: relName,                 // 这里存储关系名称
                    value: 3
                });
            });

            return {
                nodes: Object.values(nodesMap),
                links: links
            };
        }

        var graph = processData(serverData);

        // ==========================================
        // 2. D3 渲染逻辑
        // ==========================================

        var svg = d3.select("svg"),
            width = 960,
            height = 600,
            g = svg.append("g");

        var color = d3.scaleOrdinal(d3.schemeCategory20);
        var nodeRadius = Math.min(width, height) / CONFIG.nodeRadiusDivisor;

        // 力导向模拟器
        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(CONFIG.linkDistance))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(nodeRadius + 20));

        // 绘制顺序优化：连线 -> 连线文字 -> 节点 -> 节点文字
        // 这样节点可以遮挡住穿过它下方的连线文字，看起来更整洁

        // 1. 绘制连线
        var link = g.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line")
            .attr("stroke-width", 1.5);

        // 2. 绘制连线上的关系文字 (新增功能)
        var linkLabels = g.append("g")
            .attr("class", "link-labels")
            .selectAll("text")
            .data(graph.links)
            .enter().append("text")
            .attr("class", "link-label")
            .style("font-size", CONFIG.linkFontSize + "px") // 使用配置的小字体
            .text(function(d) { return d.type; });

        // 3. 绘制节点圆圈
        var node = g.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter().append("circle")
            .attr("r", nodeRadius)
            .attr("fill", function(d) { return color(d.group); })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // 节点点击跳转
        node.on("click", function(d) {
            window.location.href = "read_single_character/" + d.id;
        });

        // 4. 绘制节点旁边的人物名称
        var labels = g.append("g")
            .attr("class", "labels")
            .selectAll("text")
            .data(graph.nodes)
            .enter().append("text")
            .attr("class", "node-label")
            .style("font-size", CONFIG.nodeFontSize + "px")
            .text(function(d) { return d.name; });

        // 鼠标悬停提示
        node.append("title")
            .text(function(d) { return d.name; });

        // 启动模拟
        simulation
            .nodes(graph.nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(graph.links);

        // 缩放功能
        var zoom = d3.zoom()
            .scaleExtent([0.1, 8])
            .on("zoom", zoomed);

        svg.call(zoom);

        // 初始缩放与居中
        var initialScale = CONFIG.initialZoom;
        var initialTranslateX = (width - width * initialScale) / 2;
        var initialTranslateY = (height - height * initialScale) / 2;
        svg.call(zoom.transform, d3.zoomIdentity.translate(initialTranslateX, initialTranslateY).scale(initialScale));

        function zoomed() {
            g.attr("transform", d3.event.transform);
        }

        // 实时更新位置
        function ticked() {
            // 更新连线位置
            link
                .attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            // 更新连线文字位置 (放在连线中点)
            linkLabels
                .attr("x", function(d) { return (d.source.x + d.target.x) / 2; })
                .attr("y", function(d) { return (d.source.y + d.target.y) / 2; });

            // 更新节点位置
            node
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });

            // 更新人物名称位置 (节点下方)
            labels
                .attr("x", function(d) { return d.x; })
                .attr("y", function(d) { return d.y + nodeRadius + 12; });
        }

        // 拖拽控制函数
        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // 窗口大小调整适配
        window.addEventListener('resize', function() {
            var newWidth = window.innerWidth - 40;
            var newHeight = window.innerHeight - 160;
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>

</html>